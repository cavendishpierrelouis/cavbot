<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Control Room · Pick the Imposter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Interactive CavBot inspection deck — scan the grid, pick the impostor, and send the route back to the main map.">
  <meta name="robots" content="noindex, nofollow">

  <!-- Shared CavBot styles -->
  <link rel="stylesheet" href="/cavbotcore/badge.css">
  <link rel="stylesheet" href="/cavbotcore/head.css">

  <!-- Game-specific styles -->
  <style>
    :root {
      --bg: #202124;
      --panel: #181a20;
      --panel-raised: #212328;
      --ink: #f2f2f2;
      --muted: #b0b7c3;
      --grid-line: rgba(255,255,255,0.05);
      --accent-blue: #006ee6;
      --accent-lime: #b5d331;
      --accent-purple: #7852a9;
      --radius-lg: 24px;
      --radius-md: 18px;
      --radius-sm: 12px;
      --shadow-soft: 0 18px 50px rgba(0,0,0,0.7);
      --font-sans: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    html {
      margin: 0;
      padding: 0;
      scroll-behavior: smooth;
      -webkit-text-size-adjust: 100%;
    }

    body.error-page {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #252832 0, #202124 48%, #111215 100%);
      color: var(--ink);
      font: 16px/1.6 var(--font-sans);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px 16px;
      overflow-x: hidden;
    }

    main {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .error-hero {
      width: 100%;
    }

    .error-shell {
      max-width: 1120px;
      margin: 0 auto;
      border-radius: var(--radius-lg);
      background:
        radial-gradient(circle at top left, rgba(0,110,230,0.16), transparent 60%),
        radial-gradient(circle at bottom right, rgba(184,211,49,0.12), transparent 60%),
        linear-gradient(150deg, #262931 0%, #181a20 55%, #15161c 100%);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 22px 22px 20px;
      display: flex;
      flex-direction: column;
      gap: 22px;
      box-shadow: var(--shadow-soft);
    }

    @media (max-width: 768px) {
      body.error-page {
        padding: 16px 10px;
      }
      .error-shell {
        padding: 18px 14px 16px;
        border-radius: 18px;
      }
    }

    /* HUD / TOP SECTION */
    .error-hud {
      display: grid;
      grid-template-columns: minmax(0, 1.9fr) minmax(0, 1.1fr);
      gap: 18px 28px;
      align-items: flex-start;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 16px;
    }

    @media (max-width: 860px) {
      .error-hud {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .hud-main {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hud-meta {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-end;
      font-variant-numeric: tabular-nums;
      gap: 4px;
    }

    .hud-timer {
      margin: 0;
      font-size: 0.82rem;
      text-align: right;
      color: var(--muted);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .hud-timer-label {
      margin-right: 0.45em;
    }

    .hud-timer-value {
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }

    /* CavBot DM header */
    .cavbot-dm {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-top: 4px;
    }

    @media (max-width: 600px) {
      .cavbot-dm {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .cavbot-dm-avatar {
      width: 56px;
      height: 56px;
      border-radius: 9999px;
      background:
        radial-gradient(circle at 20% 0%, rgba(255,255,255,0.18), transparent 55%),
        radial-gradient(circle at 80% 100%, rgba(0,110,230,0.22), transparent 55%),
        linear-gradient(145deg, #20232b 0%, #12141a 100%);
      border: 1px solid rgba(255,255,255,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .cavbot-dm-avatar-core {
      width: 40px;
      height: 30px;
      border-radius: 18px;
      background:
        linear-gradient(145deg, #fdfdfd 0%, #e7eaf2 40%, #cbd0de 70%, #aeb5c7 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 4px 5px;
      overflow: hidden;
    }

    .cavbot-dm-face {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      background:
        radial-gradient(circle at 20% 0%, rgba(0,110,230,0.35), transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(120,82,169,0.5), transparent 55%),
        linear-gradient(160deg, #05060a 0%, #05060d 45%, #060b17 100%);
      padding: 6px 5px 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cavbot-dm-eyes-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .cavbot-dm-eye {
      position: relative;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(circle at 50% 70%, rgba(0,0,0,0.8), #020307 78%);
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.12),
        0 0 10px rgba(0,110,230,0.6);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cavbot-dm-eye-inner {
      position: relative;
      width: 72%;
      height: 72%;
      border-radius: inherit;
      background: radial-gradient(circle, rgba(0,0,0,1) 0%, #050916 80%);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cavbot-dm-eye-pupil {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #ffffff 0%, #d2f2ff 20%, #0094ff 65%, #003b7a 100%);
      box-shadow:
        0 0 6px rgba(0,110,230,0.8),
        0 0 10px rgba(181,211,49,0.4);
      transform: translate(0, 0);
      transition: transform 0.09s ease-out;
    }

    .cavbot-dm-eye-glow {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle, rgba(181,211,49,0.3) 0%, transparent 70%);
      opacity: 0.14;
      pointer-events: none;
    }

    .cavbot-dm-blink {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.95) 60%);
      transform-origin: top center;
      transform: scaleY(0);
      opacity: 0;
      pointer-events: none;
      animation: cavbotBlink 7.2s infinite;
    }

    .cavbot-dm-chat {
      flex: 1;
      border-radius: var(--radius-md);
      background:
        radial-gradient(circle at top, rgba(0,110,230,0.24), transparent 55%),
        radial-gradient(circle at bottom, rgba(120,82,169,0.2), transparent 55%),
        linear-gradient(160deg, #181a20 0%, #101117 100%);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px 11px;
      font-family: var(--mono);
      font-size: 0.8rem;
      color: #e6ecff;
      position: relative;
    }

    .cavbot-dm-line {
      margin: 0;
      line-height: 1.5;
    }

    .cavbot-dm-line .cavbot-dm-segment {
      white-space: pre-wrap;
    }

    .cavbot-dm-email {
      color: var(--accent-lime);
      text-decoration: none;
      font-weight: 500;
    }

    .cavbot-dm-email:hover {
      text-decoration: underline;
    }

    .cavbot-dm-cursor {
      display: inline-block;
      width: 0.6em;
      margin-left: 1px;
      animation: dmCursorBlink 1s steps(1, end) infinite;
    }

    @keyframes dmCursorBlink {
      0%, 50% { opacity: 1; }
      50.01%, 100% { opacity: 0; }
    }

    @keyframes cavbotBlink {
      0%, 86%, 100%   { transform: scaleY(0); opacity: 0; }
      88%, 90%       { transform: scaleY(1); opacity: 0.9; }
      92%            { transform: scaleY(0); opacity: 0; }
    }

    /* CONTROL CONSOLE */
    .control-console {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px 12px 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.08);
      background:
        radial-gradient(circle at top, rgba(0,110,230,0.22), transparent 55%),
        radial-gradient(circle at bottom, rgba(181,211,49,0.18), transparent 60%),
        linear-gradient(165deg, #181a20 0%, #101117 100%);
    }

    .console-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    @media (max-width: 640px) {
      .console-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .hud-meta {
        align-items: flex-start;
      }
    }

    .console-main {
      display: grid;
      grid-template-columns: minmax(0, 1.9fr) minmax(0, 1.1fr);
      gap: 12px;
      align-items: stretch;
    }

    @media (max-width: 920px) {
      .console-main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .console-log-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* INSPECTION DECK */
    .inspection-deck {
      position: relative;
      border-radius: var(--radius-md);
      min-height: 340px;
      background:
        radial-gradient(circle at top, rgba(0,110,230,0.24), transparent 55%),
        radial-gradient(circle at bottom, rgba(120,82,169,0.2), transparent 55%),
        linear-gradient(160deg, #181a20 0%, #101117 100%);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.08);
      isolation: isolate;
      padding: 40px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .inspection-deck::before {
      content: "";
      position: absolute;
      inset: 0;
      opacity: 0.35;
      pointer-events: none;
      background-image:
        linear-gradient(to right, var(--grid-line) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px);
      background-size: 52px 52px;
    }

    .inspection-deck::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 18% 16%, rgba(181,211,49,0.18), transparent 56%),
        radial-gradient(circle at 84% 82%, rgba(120,82,169,0.22), transparent 60%);
      mix-blend-mode: screen;
      opacity: 0.9;
    }

    .inspection-deck-label {
      position: absolute;
      top: 8px;
      left: 10px;
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(5,6,9,0.82);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--muted);
      z-index: 2;
    }

    .inspection-deck-subline {
      position: absolute;
      top: 8px;
      right: 12px;
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(4,6,11,0.9);
      border: 1px solid rgba(0,110,230,0.4);
      color: #e6ecff;
      z-index: 2;
    }

    .imposter-grid-shell {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .imposter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
    }

    @media (max-width: 720px) {
      .imposter-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 520px) {
      .inspection-deck {
        padding: 40px 10px 14px;
      }
      .imposter-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .imposter-cell {
      position: relative;
      border-radius: 18px;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.08), transparent 60%),
        linear-gradient(160deg, rgba(8,10,18,0.96), rgba(4,5,10,0.98));
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 8px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
      cursor: pointer;
      outline: none;
    }

    .imposter-cell:hover {
      transform: translateY(-3px);
      box-shadow:
        0 18px 34px rgba(0,0,0,0.9),
        0 0 18px rgba(0,110,230,0.45);
      border-color: rgba(0,110,230,0.65);
    }

    .imposter-cell--caught {
      transform: translateY(-2px) scale(1.02);
      box-shadow:
        0 20px 40px rgba(0,0,0,0.98),
        0 0 30px rgba(181,211,49,1);
    }

    .imposter-cell--miss {
      border-color: rgba(255,140,128,0.7);
    }

    .imposter-cell--shake {
      animation: imposterShake 0.25s ease-out;
    }

    @keyframes imposterShake {
      0%   { transform: translateX(0); }
      25%  { transform: translateX(-4px); }
      50%  { transform: translateX(4px); }
      75%  { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }

    .imposter-head-shell {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 4px;
    }

    /* Head — using the same visual language as Catch CavBot (head only) */
    .cavbot-head {
      position: relative;
      width: 100px;
      height: 86px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 20% 0%, #ffffff 0%, #f5f7fc 32%, #d4d7e2 65%, #a8afc0 100%);
      box-shadow:
        0 -4px 12px rgba(255,255,255,0.4) inset,
        0 8px 18px rgba(0,0,0,0.35);
      padding: 14px 12px 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cavbot-head::before {
      content: "";
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 64px;
      height: 22px;
      border-radius: 999px;
      background:
        linear-gradient(135deg, #dadeea 0%, #c4c9d7 45%, #9ea3b5 100%);
      box-shadow:
        0 2px 4px rgba(0,0,0,0.25),
        0 -2px 6px rgba(255,255,255,0.65) inset;
    }

    .cavbot-face {
      position: relative;
      width: 100%;
      height: 64px;
      border-radius: 40px;
      background:
        radial-gradient(circle at 20% 0%, rgba(0,110,230,0.45), transparent 60%),
        radial-gradient(circle at 80% 10%, rgba(120,82,169,0.55), transparent 60%),
        linear-gradient(160deg,#05060a 0%,#05060d 40%,#070c18 100%);
      padding: 16px 14px 14px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow:
        0 0 0 3px rgba(0,0,0,0.85) inset,
        0 0 18px rgba(0,110,230,0.7);
    }

    .cavbot-eyes-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }

    .cavbot-eye {
      position: relative;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,0.6), transparent 65%),
        radial-gradient(circle at 50% 70%, #020306, #020309 80%);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cavbot-eye::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 2px solid rgba(0,214,255,0.85);
      box-shadow:
        0 0 12px rgba(0,214,255,0.9),
        0 0 20px rgba(0,110,230,0.9);
      opacity: 0.8;
      pointer-events: none;
    }

    .cavbot-eye-inner {
      position: relative;
      width: 78%;
      height: 78%;
      border-radius: inherit;
      background: radial-gradient(circle, #020308 0%, #050918 80%);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cavbot-eye-pupil {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #ffffff 0%, #d8f6ff 18%, #00b8ff 55%, #0060e6 100%);
      box-shadow:
        0 0 12px rgba(0,184,255,0.9),
        0 0 20px rgba(0,110,230,0.8);
      transform: translate(0, 0);
      transition: transform 0.09s ease-out;
    }

    .cavbot-eye-glow {
      position: absolute;
      inset: -4px;
      border-radius: inherit;
      background: radial-gradient(circle, rgba(181,211,49,0.4) 0%, transparent 75%);
      opacity: 0.18;
      pointer-events: none;
    }

    .cavbot-blink {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.95) 70%);
      transform-origin: top center;
      transform: scaleY(0);
      opacity: 0;
      pointer-events: none;
      animation: cavbotBlink 7.2s infinite;
    }

    /* Impostor face variant — green/anomalous field state,
       but the frame and border stay identical to other cards. */
    .imposter-cell--imposter .cavbot-face {
      background:
        radial-gradient(circle at 18% 0%, rgba(181,211,49,0.7), transparent 62%),
        radial-gradient(circle at 82% 15%, rgba(0,178,115,0.65), transparent 62%),
        linear-gradient(160deg,#020804 0%,#04110a 40%,#04170c 100%);
      box-shadow:
        0 0 0 3px rgba(0,0,0,0.9) inset,
        0 0 24px rgba(181,211,49,0.95);
    }

    .imposter-cell--imposter .cavbot-eye::before {
      border-color: rgba(181,211,49,0.95);
      box-shadow:
        0 0 14px rgba(181,211,49,0.9),
        0 0 20px rgba(157,219,46,0.9);
    }

    .imposter-cell--imposter .cavbot-eye-pupil {
      box-shadow:
        0 0 14px rgba(181,211,49,0.9),
        0 0 20px rgba(157,219,46,0.9);
    }

    .imposter-label-row {
      display: flex;
      width: 100%;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      font-family: var(--mono);
      font-size: 0.64rem;
      color: var(--muted);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .imposter-slot-id {
      opacity: 0.85;
    }

    .imposter-slot-tag {
      font-size: 0.62rem;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.12);
    }


    /* LOG CONSOLES */
    .console-log-wrap {
      border-radius: var(--radius-md);
      background: radial-gradient(circle at top left, rgba(0,0,0,0.7), rgba(0,0,0,0.96));
      border: 1px solid rgba(255,255,255,0.07);
      padding: 8px 9px 7px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .console-log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--muted);
      font-family: var(--mono);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .console-log-indicators {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
    }

    .console-log-indicators span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .console-log-led {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle, #f8f8ff 0%, #00d6ff 40%, #00304a 100%);
      box-shadow: 0 0 12px rgba(0,110,230,0.9);
      animation: logLedPulse 2.6s ease-in-out infinite;
    }

    @keyframes logLedPulse {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50%      { transform: scale(1.35); opacity: 1; }
    }

    .console-log {
      position: relative;
      border-radius: 10px;
      background: radial-gradient(circle at top left, rgba(20,22,30,0.95), rgba(7,8,13,0.98));
      border: 1px solid rgba(255,255,255,0.04);
      padding: 6px 6px 6px;
      max-height: 170px;
      overflow: hidden;
      font-family: var(--mono);
      font-size: 0.74rem;
      color: #d6deff;
    }

    .console-log-inner {
      max-height: 158px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .console-log-inner::-webkit-scrollbar {
      width: 6px;
    }

    .console-log-inner::-webkit-scrollbar-track {
      background: transparent;
    }

    .console-log-inner::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.16);
      border-radius: 999px;
    }

    .log-line {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      padding: 1px 0;
    }

    .log-line-prefix {
      color: rgba(163,172,210,0.9);
    }

    .log-line-tag {
      color: #b5d331;
    }

    .log-line-warning {
      color: #f7d27c;
    }

    .log-line-error {
      color: #ff8c80;
    }

    .log-line-ok {
      color: #9fffbf;
    }

    .console-log-footer {
      margin-top: 6px;
      font-size: 0.68rem;
      color: var(--muted);
    }

    .console-log-footer span {
      display: block;
      white-space: normal;
      line-height: 1.4;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        scroll-behavior: auto !important;
        animation-duration: 0.001ms !important;
        animation-iteration-count: 1 !important;
        transition: none !important;
      }
    }

    /* Hide any full-body CavBot pieces if head.css includes them */
    .cavbot-body,
    .cavbot-base {
      display: none !important;
    }
  </style>
</head>
<body class="error-page"
      data-cavbot-page-type="404-imposter-deck"
      data-cavbot-component="404-game-imposter">
<main>
  <section class="error-hero" aria-labelledby="error-heading">
    <div class="error-shell" role="document">
      <!-- HUD / TOP -->
      <header class="error-hud">
        <div class="hud-main">
          <h1 id="error-heading" class="visually-hidden">
            CavBot Imposter Scan Deck — Route Not Found
          </h1>

          <!-- CavBot DM header / top message stream -->
          <div class="cavbot-dm">
            <div class="cavbot-dm-avatar" aria-hidden="true">
              <div class="cavbot-dm-avatar-core">
                <div class="cavbot-dm-face">
                  <div class="cavbot-dm-eyes-row">
                    <div class="cavbot-dm-eye">
                      <div class="cavbot-dm-eye-inner">
                        <div class="cavbot-dm-eye-pupil"></div>
                      </div>
                      <div class="cavbot-dm-eye-glow"></div>
                      <div class="cavbot-dm-blink"></div>
                    </div>
                    <div class="cavbot-dm-eye">
                      <div class="cavbot-dm-eye-inner">
                        <div class="cavbot-dm-eye-pupil"></div>
                      </div>
                      <div class="cavbot-dm-eye-glow"></div>
                      <div class="cavbot-dm-blink"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="cavbot-dm-chat">
              <p class="cavbot-dm-line" id="cavbot-dm-line">
                <span class="cavbot-dm-segment" data-text="Ah, good — you made it in here. We've got a small situation."></span><br><br>
                <span class="cavbot-dm-segment" data-text="Someone in this deck is pretending to be me. Same shell, wrong CavBot."></span><br><br>
                <span class="cavbot-dm-segment" data-text="Here's the deal: you find the impostor, and I'll put your page back where it actually belongs."></span><br><br>
                <span class="cavbot-dm-segment" data-text="Scan the faces, look for the one that feels just a little off, and tag him."></span><br><br>
                <span class="cavbot-dm-segment" data-text="If that impostor keeps acting up after you tag him, forward the evidence to "></span>
                <a href="mailto:support@cavbot.io "
                   class="cavbot-dm-email cavbot-dm-segment"
                   data-text="support@cavbot.io"></a><br><br>
                <span class="cavbot-dm-segment" data-text="GO GET HIM!!!"></span>
                <span class="cavbot-dm-cursor" id="cavbot-dm-cursor">|</span>
              </p>
            </div>
          </div>
        </div>

        <div class="hud-meta" aria-label="Scan status">
          <p class="hud-timer">
            <span class="hud-timer-label">Current scan</span>
            <span class="hud-timer-value" id="stat-current">0.00s</span>
          </p>
          <p class="hud-timer">
            <span class="hud-timer-label">Best scan</span>
            <span class="hud-timer-value" id="stat-best">—</span>
          </p>
        </div>
      </header>

      <!-- CONSOLE / GAME -->
      <section class="control-console" aria-label="Imposter scan console">
        <header class="console-header">
        </header>

        <div class="console-main">
          <!-- Inspection / Imposter Deck -->
          <div class="inspection-deck"
               id="inspection-deck"
               aria-label="Imposter scan deck. Inspect each CavBot head and select the one that feels out of spec."
               role="application">
            <span class="inspection-deck-label">404 · IMPOSTER SCAN DECK</span>
            <span class="inspection-deck-subline">MODE · VISUAL INSPECTION</span>
<br>
<br>
            <div class="imposter-grid-shell">
              <div class="imposter-grid" role="group" aria-label="CavBot candidates">
                <!-- 6 slots -->
                <!-- Slot 1 -->
                <div class="imposter-cell"
                     data-index="0"
                     role="button"
                     tabindex="0"
                     aria-pressed="false"
                     aria-label="CavBot candidate in the deck.">
                  <div class="imposter-head-shell">
                    <div class="cavbot-head">
                      <div class="cavbot-face">
                        <div class="cavbot-eyes-row">
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="imposter-label-row">
                    <span class="imposter-slot-id">BOT 01</span>
                    <span class="imposter-slot-tag">CANDIDATE</span>
                  </div>
                </div>

                <!-- Slot 2 -->
                <div class="imposter-cell"
                     data-index="1"
                     role="button"
                     tabindex="0"
                     aria-pressed="false"
                     aria-label="CavBot candidate in the deck.">
                  <div class="imposter-head-shell">
                    <div class="cavbot-head">
                      <div class="cavbot-face">
                        <div class="cavbot-eyes-row">
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="imposter-label-row">
                    <span class="imposter-slot-id">BOT 02</span>
                    <span class="imposter-slot-tag">CANDIDATE</span>
                  </div>
                </div>

                <!-- Slot 3 -->
                <div class="imposter-cell"
                     data-index="2"
                     role="button"
                     tabindex="0"
                     aria-pressed="false"
                     aria-label="CavBot candidate in the deck.">
                  <div class="imposter-head-shell">
                    <div class="cavbot-head">
                      <div class="cavbot-face">
                        <div class="cavbot-eyes-row">
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="imposter-label-row">
                    <span class="imposter-slot-id">BOT 03</span>
                    <span class="imposter-slot-tag">CANDIDATE</span>
                  </div>
                </div>

                <!-- Slot 4 -->
                <div class="imposter-cell"
                     data-index="3"
                     role="button"
                     tabindex="0"
                     aria-pressed="false"
                     aria-label="CavBot candidate in the deck.">
                  <div class="imposter-head-shell">
                    <div class="cavbot-head">
                      <div class="cavbot-face">
                        <div class="cavbot-eyes-row">
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="imposter-label-row">
                    <span class="imposter-slot-id">BOT 04</span>
                    <span class="imposter-slot-tag">CANDIDATE</span>
                  </div>
                </div>

                <!-- Slot 5 -->
                <div class="imposter-cell"
                     data-index="4"
                     role="button"
                     tabindex="0"
                     aria-pressed="false"
                     aria-label="CavBot candidate in the deck.">
                  <div class="imposter-head-shell">
                    <div class="cavbot-head">
                      <div class="cavbot-face">
                        <div class="cavbot-eyes-row">
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="imposter-label-row">
                    <span class="imposter-slot-id">BOT 05</span>
                    <span class="imposter-slot-tag">CANDIDATE</span>
                  </div>
                </div>

                <!-- Slot 6 -->
                <div class="imposter-cell"
                     data-index="5"
                     role="button"
                     tabindex="0"
                     aria-pressed="false"
                     aria-label="CavBot candidate in the deck.">
                  <div class="imposter-head-shell">
                    <div class="cavbot-head">
                      <div class="cavbot-face">
                        <div class="cavbot-eyes-row">
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                          <div class="cavbot-eye">
                            <div class="cavbot-eye-inner">
                              <div class="cavbot-eye-pupil"></div>
                            </div>
                            <div class="cavbot-eye-glow"></div>
                            <div class="cavbot-blink"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="imposter-label-row">
                    <span class="imposter-slot-id">BOT 06</span>
                    <span class="imposter-slot-tag">CANDIDATE</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Logs column (Game log + Chat log) -->
          <div class="console-log-column">
            <!-- Game log -->
            <aside class="console-log-wrap" aria-label="Game log">
              <div class="console-log-header">
                <span>Game log</span>
                <div class="console-log-indicators">
                  <span><span class="console-log-led" aria-hidden="true"></span>LIVE</span>
                  <span>DECK</span>
                </div>
              </div>

              <div class="console-log" role="log" aria-live="polite" aria-atomic="false">
                <div class="console-log-inner" id="console-log-inner">
                  <!-- log lines injected via JS -->
                </div>
              </div>

              <div class="console-log-footer">
                <span>System events for this 404 inspection deck. Correctly identifying the impostor restores your route.</span>
              </div>
            </aside>

            <!-- Chat log -->
            <aside class="console-log-wrap" aria-label="Chat log">
              <div class="console-log-header">
                <span>Chat log</span>
                <div class="console-log-indicators">
                  <span><span class="console-log-led" aria-hidden="true"></span>LIVE</span>
                  <span>IMPOSTER</span>
                </div>
              </div>

              <div class="console-log" role="log" aria-live="polite" aria-atomic="false">
                <div class="console-log-inner" id="chat-log-inner">
                  <!-- Imposter CavBot messages injected via JS -->
                </div>
              </div>

              <div class="console-log-footer">
                <span>All commentary is from the field CavBot that pulled this route out of the map.</span>
              </div>
            </aside>
          </div>
        </div>
      </section>
    </div>
  </section>
</main>

<!-- Analytics bridge (window.cavbotAnalytics.track) -->
<script src="/cavbotcore/cavbot-analytics.js"></script>

<!-- Game logic -->
<script>
(function () {
  'use strict';

  const REDIRECT_ON_CATCH = true;
  const REDIRECT_TARGET = 'index.html#top';
  const REDIRECT_DELAY_MS = 3800;

  const STORAGE_PREFIX = 'cavbotImposter_';

  const deckEl = document.getElementById('inspection-deck');
  const cells = Array.prototype.slice.call(document.querySelectorAll('.imposter-cell'));
  const pupils = document.querySelectorAll('.imposter-cell .cavbot-eye-pupil, .cavbot-dm-eye-pupil');

  const statCurrentEl = document.getElementById('stat-current');
  const statBestEl = document.getElementById('stat-best');
  const logInnerEl = document.getElementById('console-log-inner');
  const chatInnerEl = document.getElementById('chat-log-inner');
  const statusEl = document.getElementById('console-status');

  const dmLineEl = document.getElementById('cavbot-dm-line');
  const dmCursorEl = document.getElementById('cavbot-dm-cursor');
  const dmSegments = dmLineEl ? Array.prototype.slice.call(dmLineEl.querySelectorAll('.cavbot-dm-segment')) : [];

  if (!deckEl || !cells.length) {
    return;
  }

  // Helpers
  function randomFrom(arr) {
    if (!arr || !arr.length) return '';
    const idx = Math.floor(Math.random() * arr.length);
    return arr[idx];
  }

  function safeParseInt(value, fallback) {
    const n = parseInt(value, 10);
    return Number.isNaN(n) ? fallback : n;
  }

  function formatOrdinal(n) {
    const s = ['th', 'st', 'nd', 'rd'];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
  }

  function storageGet(key, fallback) {
    try {
      const raw = window.localStorage.getItem(STORAGE_PREFIX + key);
      if (raw == null) return fallback;
      return raw;
    } catch (e) {
      return fallback;
    }
  }

  function storageSet(key, value) {
    try {
      window.localStorage.setItem(STORAGE_PREFIX + key, String(value));
    } catch (e) {
      // ignore
    }
  }

  // Visitor profile for this game only
  function initVisitorProfile() {
    const now = new Date();
    const nowIso = now.toISOString();
    const today = nowIso.slice(0, 10);

    const prevVisitRaw = storageGet('visitCount', null);
    const visitCount = prevVisitRaw ? safeParseInt(prevVisitRaw, 0) + 1 : 1;

    let totalMisses = safeParseInt(storageGet('totalMisses', '0'), 0);
    let totalCatches = safeParseInt(storageGet('totalCatches', '0'), 0);
    let bestScanMs = null;
    const bestRaw = storageGet('bestScanMs', null);
    if (bestRaw != null) {
      const n = Number(bestRaw);
      bestScanMs = Number.isNaN(n) ? null : n;
    }

    let lastVisitAt = storageGet('lastVisitAt', null);
    let currentDayCountRaw = storageGet('currentDayCount', null);
    let currentDayCount = 1;

    if (lastVisitAt && lastVisitAt.slice(0, 10) === today) {
      const prevDayCount = safeParseInt(currentDayCountRaw, 0);
      currentDayCount = prevDayCount > 0 ? prevDayCount + 1 : 1;
    } else {
      currentDayCount = 1;
    }

    lastVisitAt = nowIso;

    const profile = {
      visitCount: visitCount,
      totalMisses: totalMisses,
      totalCatches: totalCatches,
      bestScanMs: bestScanMs,
      lastVisitAt: lastVisitAt,
      currentDayCount: currentDayCount
    };

    persistVisitorProfile(profile);
    return profile;
  }

  function persistVisitorProfile(profile) {
    if (!profile) return;
    storageSet('visitCount', profile.visitCount || 1);
    storageSet('totalMisses', profile.totalMisses || 0);
    storageSet('totalCatches', profile.totalCatches || 0);
    if (profile.bestScanMs != null) {
      storageSet('bestScanMs', Math.floor(profile.bestScanMs));
    }
    if (profile.lastVisitAt) {
      storageSet('lastVisitAt', profile.lastVisitAt);
    }
    if (profile.currentDayCount != null) {
      storageSet('currentDayCount', profile.currentDayCount);
    }
  }

  const visitorProfile = initVisitorProfile();

  const state = {
    imposterIndex: 0,
    roundStart: null,
    caught: false,
    visitCount: visitorProfile.visitCount,
    visitorProfile: visitorProfile,
    missCount: 0,
    sessionCatchCount: 0,
    totalScanTimeMs: 0,
    lastScanMs: null,
    bestMsSession: null,
    idleTimer1: null,
    idleTimer2: null,
    idleLevel1Fired: false,
    idleLevel2Fired: false,
    lastInteractionTs: 0,
    consecutiveMisses: 0,
    timerRaf: null
  };

  // Analytics bridge
  function trackAnalytics(eventName, payload) {
    if (typeof window === 'undefined') return;
    try {
      if (window.cavbotAnalytics && typeof window.cavbotAnalytics.track === 'function') {
        window.cavbotAnalytics.track(
          eventName,
          Object.assign({ eventName: eventName }, payload || {})
        );
      }
    } catch (e) {
      // never break gameplay
    }
  }

  // Skill summary for this game
  function summarizeVisitorProfile(profile) {
    if (!profile) return null;
    const totalEvents = profile.totalMisses + profile.totalCatches;
    const successRate = totalEvents > 0 ? profile.totalCatches / totalEvents : null;

    let skillTier = 'rookie-inspector';
    let label = 'New inspector in the CavBot deck.';

    if (profile.totalCatches === 0) {
      if (profile.totalMisses >= 40) {
        label = 'Stubborn scanner still hunting for a first correct impostor.';
        skillTier = 'stubborn-inspector';
      } else if (profile.totalMisses >= 15) {
        label = 'Curious analyst calibrating their eye for anomalies.';
        skillTier = 'pattern-learner';
      } else if (profile.visitCount > 1) {
        label = 'Returning inspector still mapping the deck.';
        skillTier = 'returning-rookie';
      } else {
        label = 'First-time visitor scanning the rows.';
      }
    } else {
      if (successRate != null) {
        if (successRate < 0.2) {
          label = 'Determined inspector with growing impostor catches.';
          skillTier = 'steady-inspector';
        } else if (successRate < 0.5) {
          label = 'Resilient scanner converting inspections steadily.';
          skillTier = 'deck-operator';
        } else if (successRate < 0.8) {
          label = 'Calibrated eye with strong impostor identification.';
          skillTier = 'field-analyst';
        } else {
          label = 'Precision inspector with a very high pick accuracy.';
          skillTier = 'quiet-sniper';
        }
      } else {
        label = 'Determined learner with early impostor success.';
        skillTier = 'steady-inspector';
      }
    }

    return {
      skillTier: skillTier,
      label: label,
      successRate: successRate,
      totalMisses: profile.totalMisses,
      totalCatches: profile.totalCatches,
      visitCount: profile.visitCount,
      currentDayCount: profile.currentDayCount
    };
  }

  // DM typewriter
  function startDmTypewriter() {
    if (!dmSegments.length || !dmCursorEl) return;

    let segIndex = 0;

    function typeNextSegment() {
      if (segIndex >= dmSegments.length) {
        return;
      }

      const el = dmSegments[segIndex];
      const full = el.getAttribute('data-text') || '';
      let charIndex = 0;

      function step() {
        el.textContent = full.slice(0, charIndex);
        charIndex += 1;

        if (charIndex <= full.length) {
          const base = 24;
          const jitter = Math.random() * 26;
          setTimeout(step, base + jitter);
        } else {
          segIndex += 1;
          if (segIndex < dmSegments.length) {
            setTimeout(typeNextSegment, 360);
          }
        }
      }

      step();
    }

    typeNextSegment();
  }

  // Logs
  function scrollLogToBottom() {
    if (!logInnerEl) return;
    logInnerEl.scrollTop = logInnerEl.scrollHeight;
  }

  function appendLogLine(text, opts) {
    if (!logInnerEl) return;
    const options = opts || {};
    const lineEl = document.createElement('div');
    lineEl.className = 'log-line';

    const prefixSpan = document.createElement('span');
    prefixSpan.className = 'log-line-prefix';

    const tagSpan = document.createElement('span');
    if (options.level === 'error') {
      tagSpan.className = 'log-line-error';
      prefixSpan.textContent = '[ERR] ';
    } else if (options.level === 'warn') {
      tagSpan.className = 'log-line-warning';
      prefixSpan.textContent = '[WARN] ';
    } else if (options.level === 'ok') {
      tagSpan.className = 'log-line-ok';
      prefixSpan.textContent = '[OK] ';
    } else {
      tagSpan.className = 'log-line-tag';
      prefixSpan.textContent = '[SYS] ';
    }

    const now = new Date();
    const ts = now.toLocaleTimeString('en-US', { hour12: false });
    const tsSpan = document.createElement('span');
    tsSpan.textContent = ' ' + ts + ' · ';

    tagSpan.textContent = text;

    lineEl.appendChild(prefixSpan);
    lineEl.appendChild(tsSpan);
    lineEl.appendChild(tagSpan);
    logInnerEl.appendChild(lineEl);

    const maxLines = 140;
    while (logInnerEl.children.length > maxLines) {
      logInnerEl.removeChild(logInnerEl.firstChild);
    }

    scrollLogToBottom();
  }

  // Chat log (impostor voice)
  function appendChatLine(text) {
    if (!chatInnerEl || !text) return;

    const lineEl = document.createElement('div');
    lineEl.className = 'log-line';

    const prefixSpan = document.createElement('span');
    prefixSpan.className = 'log-line-prefix';
    prefixSpan.textContent = '[CAV] ';

    const now = new Date();
    const ts = now.toLocaleTimeString('en-US', { hour12: false });
    const tsSpan = document.createElement('span');
    tsSpan.textContent = ' ' + ts + ' · ';

    const tagSpan = document.createElement('span');
    tagSpan.className = 'log-line-tag';
    tagSpan.textContent = text;

    lineEl.appendChild(prefixSpan);
    lineEl.appendChild(tsSpan);
    lineEl.appendChild(tagSpan);
    chatInnerEl.appendChild(lineEl);

    const maxLines = 90;
    while (chatInnerEl.children.length > maxLines) {
      chatInnerEl.removeChild(chatInnerEl.firstChild);
    }

    chatInnerEl.scrollTop = chatInnerEl.scrollHeight;
  }

  function typewriterLogLines(lines, index) {
    if (!Array.isArray(lines) || !lines.length || !logInnerEl) return;
    const i = typeof index === 'number' ? index : 0;
    if (i >= lines.length) return;

    const text = lines[i];
    const lineEl = document.createElement('div');
    lineEl.className = 'log-line';

    const prefixSpan = document.createElement('span');
    prefixSpan.className = 'log-line-prefix';
    prefixSpan.textContent = '[SYS] ';

    const now = new Date();
    const tsSpan = document.createElement('span');
    tsSpan.textContent = ' ' + now.toLocaleTimeString('en-US', { hour12: false }) + ' · ';

    const textSpan = document.createElement('span');
    textSpan.className = 'log-line-tag';

    lineEl.appendChild(prefixSpan);
    lineEl.appendChild(tsSpan);
    lineEl.appendChild(textSpan);
    logInnerEl.appendChild(lineEl);

    let idx = 0;
    function step() {
      textSpan.textContent = text.slice(0, idx);
      idx += 1;
      scrollLogToBottom();
      if (idx <= text.length) {
        setTimeout(step, 26);
      } else if (i + 1 < lines.length) {
        setTimeout(function () {
          typewriterLogLines(lines, i + 1);
        }, 380);
      }
    }
    step();
  }

  // Timer
  function updateCurrentTimer() {
    if (!state.roundStart || state.caught) {
      state.timerRaf = null;
      return;
    }
    const now = performance.now();
    const elapsedMs = now - state.roundStart;
    const seconds = elapsedMs / 1000;
    if (statCurrentEl) {
      statCurrentEl.textContent = seconds.toFixed(2) + 's';
    }
    state.timerRaf = requestAnimationFrame(updateCurrentTimer);
  }

  function updateBestTime(elapsedMs) {
    if (typeof elapsedMs !== 'number' || elapsedMs <= 0) {
      return { isSessionBest: false, isLifetimeBest: false };
    }

    let isSessionBest = false;
    let isLifetimeBest = false;

    if (state.bestMsSession == null || elapsedMs < state.bestMsSession) {
      state.bestMsSession = elapsedMs;
      isSessionBest = true;
    }

    const profile = state.visitorProfile;
    if (profile) {
      if (typeof profile.bestScanMs === 'number') {
        if (elapsedMs < profile.bestScanMs) {
          profile.bestScanMs = elapsedMs;
          isLifetimeBest = true;
        }
      } else {
        profile.bestScanMs = elapsedMs;
        isLifetimeBest = true;
      }
      persistVisitorProfile(profile);
    }

    const bestToShow = state.visitorProfile && state.visitorProfile.bestScanMs != null
      ? state.visitorProfile.bestScanMs
      : state.bestMsSession;

    if (statBestEl && bestToShow != null) {
      const seconds = (bestToShow / 1000).toFixed(2);
      statBestEl.textContent = seconds + 's';
    }

    return {
      isSessionBest: isSessionBest,
      isLifetimeBest: isLifetimeBest
    };
  }

  function logSessionSummary() {
    const profile = state.visitorProfile;
    const bestMs = profile && profile.bestScanMs != null ? profile.bestScanMs : state.bestMsSession;
    const bestStr = bestMs ? (bestMs / 1000).toFixed(2) + 's' : 'n/a';

    appendLogLine(
      'SESSION SUMMARY · ' +
      state.sessionCatchCount + ' impostor catch' + (state.sessionCatchCount === 1 ? '' : 'es') +
      ' · ' + state.missCount + ' wrong picks · best scan ' + bestStr + ' · deck closing soon.',
      { level: 'ok' }
    );

    const summary = summarizeVisitorProfile(profile);

    trackAnalytics('cavbot_imposter_session_summary', {
      visitCount: state.visitCount,
      sessionCatches: state.sessionCatchCount,
      sessionMisses: state.missCount,
      bestScanMs: bestMs || null,
      totalMisses: profile ? profile.totalMisses : null,
      totalCatches: profile ? profile.totalCatches : null,
      skillTier: summary ? summary.skillTier : null,
      successRate: summary && summary.successRate != null
        ? Number((summary.successRate * 100).toFixed(2))
        : null,
      currentDayCount: profile ? profile.currentDayCount : null
    });
  }

  // Message banks — impostor personality (field CavBot)
  const MISS_CHATS_EARLY = [
    'Nice guess, wrong helmet. That one’s just standard issue.',
    'You tapped a clean bot. I’m the one who slipped off the main map.',
    'That CavBot is innocent. Quiet, but innocent.',
    'Grid event logged: “confident miss.” Keep scanning.',
    'You’re checking faces. Smart. Now pay attention to the small details.',
    'Wrong head, right idea. The impostor is dressed to leave the rack.',
    'You almost flagged a colleague. I’ll let them know you spared them.',
    'Nice click. Wrong hardware signature.',
    'You’re seeing patterns, but not the anomaly yet.',
    'That bot’s still on factory firmware. I’m the modded one.',
    'Close. Your eye is waking up.',
    'You tagged a lab tech, not the field agent.',
    'Helmet looks too clean on that one, doesn’t it?',
    'That click grazed my ego, not my actual slot.',
    'You picked confidence. I’m hiding in subtle detail.',
    'That bot is logged as “good citizen.” I’m the trouble.',
    'Candid feedback: your instincts are good, your aim is early.',
    'You flicked to the right row, wrong column.',
    'You’ve got deck presence. Now tighten the read.',
    'I’m not in standard display mode. I’m in deployment mode.',
    'That one’s still plugged into the rack. I’m already halfway out the door.',
    'You’re hovering in the correct half of the grid.',
    'You clicked where your eyes landed, not where your brain whispered.',
    'That pick was stylish. Accuracy is still buffering.',
    'You’re treating this like a quiz. It’s a scan. Take another.',
    'Wrong bot, but your pattern is getting sharper.',
    'You tagged a dummy unit. I’m the one that bit the route.',
    'Those eyes are calibration mode. Mine are mission mode.',
    'That CavBot would never steal a route. I absolutely would.',
    'You clicked an intern. I’m senior chaos staff.',
    'You’re reading the frame; the anomaly sits in the face.',
    'Fast click, soft reasoning. Try it in reverse next time.',
    'You picked the bot that looks most like a mascot, not the one acting like a leak.',
    'That CavBot reports to QA. I report to nobody.',
    'You chose symmetry. The impostor lives in the imperfection.',
    'You picked the first bot that “felt wrong.” The real one feels slightly off, not loud.',
    'You went for drama. The impostor went for discipline.',
    'You clicked a comfortable choice. I’m the uncomfortable one.',
    'That one’s still in training logs. I’m already in production.',
    'You’re guessing at vibes. Try scanning for intent.'
  ];

  const MISS_CHATS_MID = [
    'You’re circling me. I can feel it. Still wrong face, though.',
    'You picked by vibe; next round, pick by hardware.',
    'You’re in the right row. Try shifting one slot over next time.',
    'Good read, off by a single helmet.',
    'You’re starting to see the difference between “display” and “deployment.”',
    'You almost picked my neighbor, which is flattering for them.',
    'The impostor glow is there. Your eyes slid past it.',
    'That bot reports to diagnostics. I report to nowhere.',
    'You clicked a perfectly obedient unit. Boring.',
    'You’re scanning like an auditor now. One notch tighter.',
    'You’re noticing edges, reflections, halo. Stay with that.',
    'You went for symmetry. I’m hiding in the small asymmetry.',
    'The anomaly is subtle—but not invisible.',
    'I nudged my hardware just a bit off-spec. You still missed.',
    'You’re a frame ahead of the last guess. Keep advancing.',
    'The deck is watching you learn. I’m watching too.',
    'You’re hovering your mouse over the right quadrant before committing.',
    'You’re trying to out-think me. Good. You’re close.',
    'That candidate looked guilty. I’m the one who is.',
    'You selected a bot that still answers to “test instance.”',
    'You checked expression. The tell is in the hardware.',
    'You’re reading the grid like logs. One more pass.',
    'You nearly flagged my shadow. I’m two centimeters left.',
    'That miss was a strong diagnostic tap. Try again.',
    'You just confirmed who is not the impostor. That’s progress.',
    'You’re narrowing down the deck. My options are shrinking.',
    'You’re thinking slower, clicking smarter. Dangerous combo.',
    'You went for the loudest glow. The anomaly glows differently.',
    'You’re building a mental diff of every helmet in here.',
    'We both know that click almost went somewhere else.',
    'You’re running pattern-matching in your head without realizing it.',
    'You’re starting to remember which bots you’ve already cleared.',
    'Your cursor hesitated over me for a second. I saw that.',
    'You nearly trusted that hesitation. Next time, listen to it.',
    'You’re not lost. You’re in the middle of a very small investigation.',
    'Every miss is tightening your model of what “normal” looks like in this grid.'
  ];

  const MISS_CHATS_LATE = [
    'At this point, you know the deck better than some technicians.',
    'You’ve eliminated half the suspects. I’m getting a little nervous.',
    'You’re still here? I underestimated your inspection stamina.',
    'You’re running a full audit on a 404. Respect.',
    'That was a serious, deliberate pick. Still wrong, but serious.',
    'You’ve ruled out so many bots I’m running out of cover.',
    'You’re doing investigator work, not casual clicking.',
    'Your brain has this layout cached now. Use that.',
    'You miss, adjust, and try again. That’s inspector energy.',
    'The grid’s starting to feel like home, isn’t it?',
    'You’ve cross-checked these faces more than QA does.',
    'You’re building a case file on me without realizing it.',
    'You’re not lost; you’re just mid-investigation.',
    'Every wrong CavBot makes it clearer who I actually am.',
    'You could have bounced. You stayed. That matters more than this miss.',
    'You’re basically doing interrogation with your cursor.',
    'You’ve turned a wrong route into training for your eye.',
    'Logbook note: inspector refuses to give up.',
    'You keep picking, I keep dodging. For now.',
    'You’re outlasting the error message. That’s rare.',
    'You’re not here by accident anymore. You chose to keep looking.',
    'You’re stubborn in the best way.',
    'You’ve earned the catch animation when it lands.',
    'You’ve made this tiny deck your practice ground.',
    'You’re closer than these misses make it look.',
    'You’re not failing—you’re narrowing the only slot left.',
    'You’ve seen enough wrong answers to feel the right one coming.',
    'The route isn’t the only thing you’re about to restore.',
    'One day, this will just be a funny little log entry.',
    'You’ve already done more work here than most users will ever see.',
    'You’ve mapped the deck in your mind; now you just need the last flag.',
    'Your persistence is louder than every miss.',
    'You’re proving something to yourself that has nothing to do with a 404.',
    'This is no longer an error page; it’s a micro-training ground.',
    'You’re the kind of person who finishes the puzzle, even when it’s hidden in a detour.'
  ];

  const COACH_LINES = [
    'Slow your eyes, take one more full scan, then commit to a single candidate.',
    'Don’t guess fast. Read the faces, the halo, the way the hardware sits.',
    'Start by eliminating who looks safest, then pick from what’s left.',
    'If you feel stuck, breathe once, blink slow, and look only for what feels off.',
    'Treat this like a small puzzle, not a test. You can’t fail—only learn.',
    'You’re allowed to take your time here. Nothing moves until you tap.',
    'Your brain has already seen the impostor. Trust that tiny “wait, that one” signal.',
    'Don’t chase perfection. Just pick the best candidate and see what the deck says.',
    'You’re not being graded. This is just you, me, and a grid.',
    'You can step away and come back. The deck will still be here.',
    'Scan once for shape, once for glow, once for attitude. Then choose.',
    'If two candidates look suspicious, notice which one keeps pulling your attention back.',
    'Ignore the urge to “just get it over with.” You’re allowed to be precise.',
    'Think like a systems engineer: rule things out methodically, then act.',
    'You can’t get this wrong enough times to disqualify yourself. You just keep learning.',
    'If your first thought and your second thought disagree, check the second one again.',
    'Treat every miss as a data point, not a verdict.',
    'The impostor isn’t louder; it just doesn’t match the pattern.',
    'When in doubt, pick the one that feels slightly too prepared.',
    'You don’t need to be fast here. You just need to be honest with what you see.'
  ];

  const CATCH_FAST_LINES = [
    'Whoa. That was instant. You clocked the out-of-spec face in one glance.',
    'You snapped straight to the anomaly and didn’t hesitate. Respect.',
    'Okay, wow. You saw me before I even finished enjoying the disguise.',
    'Speed-run inspector. Route stolen, route recovered, all in one breath.',
    'You picked me like you’d done this a hundred times.',
    'You treated that grid like a checklist, not a maze.',
    'You saw the signal, not the noise. Beautiful work.',
    'Fast eyes, calm hand. Very dangerous combination.',
    'That pick was clean enough to ship as a feature.',
    'You’re operating at “how did you see that so quickly?” levels.',
    'You skipped guesswork and went straight to certainty.',
    'You made this whole detour feel like a blink.',
    'That was less “404” and more “routine inspection.”',
    'You didn’t even give my disguise a chance to breathe.',
    'You clicked like you already knew the answer when the deck loaded.'
  ];

  const CATCH_MEDIUM_LINES = [
    'Good inspection. You took your time and still landed the exact impostor.',
    'You actually investigated. Then you were right. That’s the good stuff.',
    'You read the whole deck like a log file and flagged the right anomaly.',
    'That was a proper call-out. Helmet, glow, attitude—nailed it.',
    'See? When you trust your eye, it doesn’t miss.',
    'You turned a static 404 into a tiny win. I respect that.',
    'Solid pick. No panic, just observation and one clean decision.',
    'You narrowed me down like a bug in production.',
    'You let curiosity run its course and it paid off.',
    'You made an error page feel like a solved case.',
    'You balanced patience with decisiveness exactly right.',
    'That choice looked calm from the outside. I know it wasn’t.',
    'You didn’t rush. You just aligned your instinct and your analysis.',
    'Your scan felt like a code review that ended in a clean merge.',
    'You let the pattern of “normal” settle before you pointed at “not normal.”'
  ];

  const CATCH_SLOW_LINES = [
    'You stayed, you doubted, you kept scanning—and you were right.',
    'That wasn’t luck. That was persistence graduating into clarity.',
    'You outlasted the deck, the misses, and your own second-guessing.',
    'Every wrong CavBot you tapped is sitting under this win.',
    'That pick felt like the end of a quiet little story, didn’t it?',
    'You turned frustration into a route restore. That’s rare.',
    'You’ve proven you don’t quit on yourself, even on a 404.',
    'The logs will remember that you finished this, not that you struggled.',
    'You earned this catch like a slow, steady refactor.',
    'You didn’t escape the detour—you completed it.',
    'This was less about a route and more about you not walking away.',
    'You kept showing up until clarity arrived. That’s a skill.',
    'You taught your brain what “impostor” looks like, one miss at a time.',
    'You solved a puzzle that almost no one sees as a puzzle.',
    'You gave yourself a small win in a place built for errors.'
  ];

  const IDLE_LINES_LEVEL1 = [
    'Still there, inspector? The deck is quiet, but the impostor is still in it.',
    'If life grabbed your attention, that’s valid. I’ll keep the grid warm.',
    'We can idle here for a moment. Your route is just on pause, not lost.',
    'I’m not going anywhere. Scan again when your brain feels ready.',
    'You can think as long as you want. The impostor can’t leave this deck.',
    'No rush. This isn’t a test, it’s a tiny puzzle waiting on your timing.',
    'I muted the alarms so you can breathe. Come back when you’re ready.',
    'The deck is in standby. Your next click decides what happens.',
    'You’re allowed to pause. The route isn’t offended.',
    'When you’re done thinking, I’ll be right where you left me.',
    'This page isn’t judging you for taking a breather.',
    'You can call this a mental buffer, not a delay.',
    'Nothing here expires if you step away for a minute.',
    'If your brain needed a micro-break, that’s data too.',
    'You’re not behind. You’re just parked in a quiet control room.'
  ];

  const IDLE_LINES_LEVEL2 = [
    'Long idle detected. If you need a break, take it—but don’t count yourself out yet.',
    'You can always close this tab. You can also land one clean pick before you do.',
    'If today’s heavy, treat this like a soft win you can give yourself.',
    'You’ve already invested brainpower here. One more attempt wouldn’t be wasted.',
    'Even if everything else feels chaotic, this little grid is manageable.',
    'No one’s timing you. Whoever told you you’re “too slow” was wrong.',
    'You’re not behind. You’re just mid-process.',
    'If you come back from this pause and pick, that’s a small act of defiance.',
    'You’ve stayed longer than most people do. That says something about you.',
    'If you’re reading this, you still have one more move in you.',
    'Stepping away is allowed. Coming back is powerful.',
    'You can end this route on a win instead of a shrug.',
    'If your energy is low, aim for “one careful click,” nothing more.',
    'You don’t owe this grid anything—but you might owe yourself the finish.',
    'You’ve paused long enough to prove you’re still thinking about it.'
  ];

  const FIRST_VISIT_LINES = [
    'IMPOSTER DECK · ONLINE',
    'ROUTE · temporarily held behind one CavBot head.',
    'ENVIRONMENT · 404, but rebuilt as a visual inspection grid.',
    'OBJECTIVE · Scan the six heads and pick the impostor.',
    'Hint · one face breaks the pattern—subtle halo, subtle attitude shift.'
  ];

  const RETURN_VISIT_LINES = [
    'IMPOSTER DECK · ONLINE · returning inspector detected.',
    'PATTERN · you keep coming back to the grid instead of bouncing.',
    'ROUTE · once again parked behind a CavBot in field mode.',
    'LOG · previous visits show a preference for solving detours, not avoiding them.',
    'Welcome back · let’s see how fast you spot the impostor this time.'
  ];

  function getMissChat() {
    let pool;
    if (state.missCount <= 6) {
      pool = MISS_CHATS_EARLY;
    } else if (state.missCount <= 18) {
      pool = MISS_CHATS_MID;
    } else {
      pool = MISS_CHATS_LATE;
    }

    let line = randomFrom(pool);
    if (state.missCount >= 10 && Math.random() < 0.35) {
      line = randomFrom(COACH_LINES);
    }
    return line || randomFrom(MISS_CHATS_EARLY);
  }

  function getCatchLine(elapsedSec) {
    let pool;
    if (elapsedSec <= 2) {
      pool = CATCH_FAST_LINES;
    } else if (elapsedSec >= 12) {
      pool = CATCH_SLOW_LINES;
    } else {
      pool = CATCH_MEDIUM_LINES;
    }
    return randomFrom(pool) || 'Impostor identified. Route heading home.';
  }

  function getIdleLine(level) {
    return level === 2 ? randomFrom(IDLE_LINES_LEVEL2) : randomFrom(IDLE_LINES_LEVEL1);
  }

  function sendVisitIntro() {
    const introLines = state.visitCount === 1 ? FIRST_VISIT_LINES : RETURN_VISIT_LINES;
    introLines.forEach(function (line) {
      appendChatLine(line);
    });

    const profile = state.visitorProfile;
    const summary = summarizeVisitorProfile(profile);

    if (profile && profile.currentDayCount > 1) {
      appendLogLine(
        'DAILY · this is your ' + formatOrdinal(profile.currentDayCount) + ' visit to the impostor deck today.',
        { level: 'ok' }
      );
    }

    if (state.visitCount > 3) {
      appendLogLine(
        'VISITOR PATTERN · repeatedly returns to the impostor grid instead of leaving the error.',
        { level: 'ok' }
      );
    }

    if (profile && profile.currentDayCount >= 5) {
      appendLogLine(
        'PROFILE · high-frequency inspector detected. You might like talking to a human at hello@cavendishpierrelouis.com.',
        { level: 'ok' }
      );
    }

    if (summary) {
      const rateStr = summary.successRate != null
        ? ' · impostor catch rate ' + (summary.successRate * 100).toFixed(0) + '%'
        : '';
      appendLogLine(
        'PROFILE · ' + summary.label + rateStr,
        { level: 'ok' }
      );
      appendLogLine(
        'PROFILE · skill tier for this deck classified as “' + summary.skillTier + '”.',
        { level: 'ok' }
      );
    }
  }

  // Idle tracking
  function clearIdleTimers() {
    if (state.idleTimer1) {
      clearTimeout(state.idleTimer1);
      state.idleTimer1 = null;
    }
    if (state.idleTimer2) {
      clearTimeout(state.idleTimer2);
      state.idleTimer2 = null;
    }
  }

  function armIdleTimers() {
    if (state.caught) return;
    clearIdleTimers();
    state.idleLevel1Fired = false;
    state.idleLevel2Fired = false;

    state.idleTimer1 = setTimeout(function () {
      if (state.caught) return;
      state.idleLevel1Fired = true;
      const line = getIdleLine(1);
      appendChatLine(line);
      appendLogLine(
        'SESSION · short idle detected in impostor deck.',
        { level: 'warn' }
      );
      trackAnalytics('cavbot_imposter_idle', {
        level: 1,
        visitCount: state.visitCount,
        sessionMissCount: state.missCount,
        sessionCatchCount: state.sessionCatchCount
      });
    }, 70000);

    state.idleTimer2 = setTimeout(function () {
      if (state.caught) return;
      state.idleLevel2Fired = true;
      const line = getIdleLine(2);
      appendChatLine(line);
      appendLogLine(
        'SESSION · extended idle detected · visitor may be distracted or overwhelmed.',
        { level: 'warn' }
      );
      trackAnalytics('cavbot_imposter_idle', {
        level: 2,
        visitCount: state.visitCount,
        sessionMissCount: state.missCount,
        sessionCatchCount: state.sessionCatchCount
      });
    }, 160000);
  }

  function registerInteraction() {
    const now = Date.now();
    if (now - state.lastInteractionTs < 800) return;
    state.lastInteractionTs = now;
    armIdleTimers();
  }

  // Pupil tracking
  function resetPupils() {
    pupils.forEach(function (p) {
      p.style.transform = 'translate(0px, 0px)';
    });
  }

  function updatePupilsFromPoint(clientX, clientY) {
    const rect = deckEl.getBoundingClientRect();
    const relX = (clientX - rect.left) / rect.width - 0.5;
    const relY = (clientY - rect.top) / rect.height - 0.5;
    const clamp = function (v, min, max) {
      return v < min ? min : v > max ? max : v;
    };
    const maxShift = 6;
    const shiftX = clamp(relX * 2, -1, 1) * maxShift;
    const shiftY = clamp(relY * 2, -1, 1) * maxShift;

    pupils.forEach(function (p) {
      p.style.transform = 'translate(' + shiftX.toFixed(2) + 'px,' + shiftY.toFixed(2) + 'px)';
    });
  }

  deckEl.addEventListener('mousemove', function (evt) {
    registerInteraction();
    updatePupilsFromPoint(evt.clientX, evt.clientY);
  });

  deckEl.addEventListener('mouseleave', function () {
    resetPupils();
  });

  deckEl.addEventListener('touchstart', function (evt) {
    registerInteraction();
    const t = evt.touches[0];
    if (t) updatePupilsFromPoint(t.clientX, t.clientY);
  }, { passive: true });

  deckEl.addEventListener('touchmove', function (evt) {
    registerInteraction();
    const t = evt.touches[0];
    if (t) updatePupilsFromPoint(t.clientX, t.clientY);
  }, { passive: true });

  // Impostor selection
  function markImposter(index) {
    state.imposterIndex = index;
    cells.forEach(function (cell, i) {
      cell.classList.remove('imposter-cell--imposter', 'imposter-cell--caught');
      cell.setAttribute('aria-pressed', 'false');
      const baseLabel = 'CavBot candidate in the deck.';
      const impLabel = 'Suspected impostor CavBot. Select to attempt route restore.';
      cell.setAttribute('aria-label', i === index ? impLabel : baseLabel);
      const tag = cell.querySelector('.imposter-slot-tag');
      if (tag) {
        // visually keep all tags identical (CANDIDATE), no hinting
        tag.textContent = 'CANDIDATE';
      }
    });
    cells[index].classList.add('imposter-cell--imposter');
  }

  function startRound() {
    state.caught = false;
    state.roundStart = performance.now();
    state.consecutiveMisses = 0;
    if (statCurrentEl) {
      statCurrentEl.textContent = '0.00s';
    }
    if (statusEl) {
      statusEl.innerHTML =
        '<strong>Status:</strong> Scan the six heads and pick the CavBot that looks out of spec to restore the route.';
    }

    // choose impostor
    const idx = Math.floor(Math.random() * cells.length);
    markImposter(idx);

    if (state.timerRaf != null) {
      cancelAnimationFrame(state.timerRaf);
    }
    state.timerRaf = requestAnimationFrame(updateCurrentTimer);
    armIdleTimers();

    trackAnalytics('cavbot_imposter_round_start', {
      visitCount: state.visitCount,
      totalMisses: state.visitorProfile.totalMisses,
      totalCatches: state.visitorProfile.totalCatches
    });
  }

  function handleCatch(cellIndex, source) {
    if (state.caught) return;
    if (cellIndex !== state.imposterIndex) return;

    state.caught = true;
    clearIdleTimers();

    const cell = cells[cellIndex];
    cell.classList.add('imposter-cell--caught');
    cell.setAttribute('aria-pressed', 'true');

    const nowMs = performance.now();
    const elapsedMs = state.roundStart ? nowMs - state.roundStart : 0;
    const elapsedSec = elapsedMs / 1000;

    if (statCurrentEl) {
      statCurrentEl.textContent = elapsedSec.toFixed(2) + 's';
    }
    if (state.timerRaf != null) {
      cancelAnimationFrame(state.timerRaf);
      state.timerRaf = null;
    }

    state.sessionCatchCount += 1;
    state.totalScanTimeMs += elapsedMs;
    state.lastScanMs = elapsedMs;

    const profile = state.visitorProfile;
    if (profile) {
      profile.totalCatches += 1;
      persistVisitorProfile(profile);
    }

    const bestMeta = updateBestTime(elapsedMs);
    const catchLine = getCatchLine(elapsedSec);

    appendChatLine(catchLine);

    appendLogLine(
      'IMPOSTER IDENTIFIED · slot ' + (cellIndex + 1) + ' · input: ' + (source || 'pointer'),
      { level: 'ok' }
    );
    appendLogLine('SCAN TIME · ' + elapsedSec.toFixed(2) + 's', { level: 'ok' });

    if (profile && profile.totalCatches === 1) {
      appendLogLine(
        'MILESTONE · first-ever impostor catch logged in this deck.',
        { level: 'ok' }
      );
    }

    if (bestMeta.isLifetimeBest) {
      appendLogLine(
        'PERFORMANCE · new personal best scan: ' + elapsedSec.toFixed(2) + 's.',
        { level: 'ok' }
      );
    } else {
      const avgMs = state.sessionCatchCount > 0
        ? (state.totalScanTimeMs / state.sessionCatchCount)
        : elapsedMs;
      appendLogLine(
        'PERFORMANCE · ' + state.sessionCatchCount +
        ' catch' + (state.sessionCatchCount === 1 ? '' : 'es') +
        ' this session · last ' + elapsedSec.toFixed(2) + 's · avg ' + (avgMs / 1000).toFixed(2) + 's.',
        { level: 'ok' }
      );
    }

    logSessionSummary();

    trackAnalytics('cavbot_imposter_catch', {
      elapsedMs: elapsedMs,
      elapsedSec: elapsedSec,
      visitCount: state.visitCount,
      sessionCatchCount: state.sessionCatchCount,
      sessionMissCount: state.missCount,
      lifetimeCatches: profile ? profile.totalCatches : null,
      lifetimeMisses: profile ? profile.totalMisses : null,
      bestScanMs: profile ? profile.bestScanMs : null,
      isSessionBest: bestMeta.isSessionBest,
      isLifetimeBest: bestMeta.isLifetimeBest
    });

    typewriterLogLines([
      'ROUTE · returning from impostor custody to main site map.',
      'DECK · closing current scan state.',
      'HANDOFF · navigation control returning to primary site routes.'
    ], 0);

    if (statusEl) {
      statusEl.innerHTML =
        '<strong>Status:</strong> Impostor identified. Preparing to return you to the main map.';
    }

    if (REDIRECT_ON_CATCH && typeof window !== 'undefined' && window.location) {
      setTimeout(function () {
        try {
          window.location.href = REDIRECT_TARGET;
        } catch (e) {
          appendLogLine('Redirect failed. Please navigate back to the main map manually.', { level: 'warn' });
        }
      }, REDIRECT_DELAY_MS);
    }
  }

  function handleMiss(cellIndex) {
    if (state.caught) return;
    const cell = cells[cellIndex];
    cell.classList.add('imposter-cell--miss', 'imposter-cell--shake');
    setTimeout(function () {
      cell.classList.remove('imposter-cell--shake');
    }, 260);

    state.missCount += 1;
    state.consecutiveMisses += 1;

    const profile = state.visitorProfile;
    if (profile) {
      profile.totalMisses += 1;
      persistVisitorProfile(profile);
    }

    const humanIndex = cellIndex + 1;
    appendLogLine(
      'Pick · BOT ' + (humanIndex < 10 ? '0' + humanIndex : humanIndex) + ' flagged · non-impostor CavBot.',
      { level: 'warn' }
    );

    const chat = getMissChat();
    appendChatLine(chat);

    if (state.consecutiveMisses === 10 || state.consecutiveMisses === 15 || state.consecutiveMisses === 25) {
      const coach = randomFrom(COACH_LINES);
      appendChatLine(coach);
      appendLogLine(
        'ASSIST · ' + state.consecutiveMisses + ' wrong picks in a row · surfacing coaching line instead of more teasing.',
        { level: 'ok' }
      );
      trackAnalytics('cavbot_imposter_assist', {
        consecutiveMisses: state.consecutiveMisses,
        visitCount: state.visitCount
      });
    }

    if (profile && profile.totalCatches === 0 && profile.totalMisses === 25) {
      appendLogLine(
        'PATTERN · many attempts without a first correct pick yet · impostor CavBot will stay supportive.',
        { level: 'ok' }
      );
    }

    trackAnalytics('cavbot_imposter_miss', {
      visitCount: state.visitCount,
      sessionMissCount: state.missCount,
      lifetimeMisses: profile ? profile.totalMisses : null,
      lifetimeCatches: profile ? profile.totalCatches : null
    });
  }

  // Wire cells
  cells.forEach(function (cell) {
    const index = safeParseInt(cell.getAttribute('data-index'), 0);

    cell.addEventListener('click', function () {
      registerInteraction();
      handleGuess(index, 'click');
    });

    cell.addEventListener('keydown', function (evt) {
      if (evt.key === 'Enter' || evt.key === ' ') {
        evt.preventDefault();
        registerInteraction();
        handleGuess(index, 'keyboard');
      }
    });
  });

  function handleGuess(index, source) {
    if (state.caught) return;
    if (index === state.imposterIndex) {
      handleCatch(index, source);
    } else {
      handleMiss(index);
    }
  }

  // Initial console log
  typewriterLogLines([
    'CONTROL ROOM · ONLINE',
    'MODE · IMPOSTER SCAN DECK',
    'ROUTE · removed from navigation and hidden behind one CavBot.',
    'TASK · visually inspect the grid and pick the impostor.'
  ], 0);

  // Initial chat intro
  sendVisitIntro();

  // Analytics: session start
  (function () {
    const profile = state.visitorProfile;
    const summary = summarizeVisitorProfile(profile);
    trackAnalytics('cavbot_imposter_session_start', {
      visitCount: state.visitCount,
      currentDayCount: profile ? profile.currentDayCount : null,
      totalMisses: profile ? profile.totalMisses : null,
      totalCatches: profile ? profile.totalCatches : null,
      bestScanMs: profile ? profile.bestScanMs : null,
      successRate: summary && summary.successRate != null
        ? Number((summary.successRate * 100).toFixed(2))
        : null,
      skillTier: summary ? summary.skillTier : null
    });
  })();

  // Kick off round + DM typewriter
  startRound();
  startDmTypewriter();
})();
</script>
</body>
</html>